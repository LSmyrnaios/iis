<?xml version="1.0"?>
<workflow-app xmlns="uri:oozie:workflow:0.4" name="main">




<!-- mh: code review note

removebelowthreshold workflow is dedicated solely to filtering project reference extraction output by confidenceLevel but it could be replaced with generic thresholdfilter addressed in #1210 and available here: 

https://svn.driver.research-infrastructures.eu/driver/dnet40/modules/icm-iis-transformers/trunk/src/main/resources/eu/dnetlib/iis/transformers/common/thresholdfilter

-->




	<parameters>
        <property>
            <name>origin_1</name>
            <description>origin of the first port</description>
        </property>
        <property>
            <name>input_from_project_reference_extraction</name>
            <description>first port</description>
        </property>
        <property>
            <name>origin_2</name>
            <description>origin of the second port</description>
        </property>
        <property>
            <name>input_2</name>
            <description>second port</description>
        </property>
        <property>
            <name>origin_3</name>
            <value>$UNDEFINED$</value>
            <description>origin of the third port; optional</description>
        </property>
        <property>
            <name>input_3</name>
            <value>$UNDEFINED$</value>
            <description>third port; optional</description>
        </property>
        <property>
            <name>id_field_to_replace1</name>
            <description>name of 1st id field to replace</description>
        </property>
        <property>
            <name>id_field_to_replace2</name>
            <value>$UNDEFINED$</value>
            <description>name of 2nd id field to replace, optional property</description>
        </property>
        <property>
			<name>key_id_field</name>
			<description>id field name to group duplicate records and then collapse them into one</description>
		</property>
        <property>
			<name>schema_input</name>
			<description>input schema</description>
		</property>
        <property>
			<name>output</name>
			<description>output port</description>
		</property>
        <property>
			<name>schema_input_envelope</name>
			<description>input envelope schema</description>
		</property>
        <property>
			<name>input_id_mapping</name>
			<description>input id mapping port</description>
		</property>
        <property>
			<name>between_origin_collapser</name>
            <value>eu.dnetlib.iis.projectreferencesmerger.OriginConfidenceBetweenOriginCollapser</value>
			<description></description>
		</property>
        <property>
			<name>within_origin_collapser</name>
            <value>eu.dnetlib.iis.projectreferencesmerger.BestFilledWithinOriginCollapser</value>
			<description></description>
		</property>
        <property>
			<name>significant_fields</name>
            <value>$ALL$</value>
			<description></description>
		</property>
	</parameters>
    
    <start to="removebelowthreshold" />
	
    <action name="removebelowthreshold">
        <sub-workflow>
            <app-path>${wf:appPath()}/removebelowthreshold</app-path>
            <configuration>
                <property>
                    <name>jobTracker</name>
                    <value>${jobTracker}</value>
                </property>
                <property>
                    <name>nameNode</name>
                    <value>${nameNode}</value>
                </property>
                <property>
                    <name>queueName</name>
                    <value>${queueName}</value>
                </property>
                <!-- Working directory of the subworkflow -->
                <property>
                    <name>workingDir</name>
                    <value>${workingDir}/removebelowthreshold/working_dir</value>
                </property>
                <!-- Input ports & parameters. -->
                <property>
                    <name>origin_1</name>
                    <value>${origin_1}</value>
                </property>
                <property>
                    <name>input_from_project_reference_extraction</name>
                    <value>${input_from_project_reference_extraction}</value>
                </property>
                <property>
                    <name>origin_2</name>
                    <value>${origin_2}</value>
                </property>
                <property>
                    <name>input_2</name>
                    <value>${input_2}</value>
                </property>
                <property>
                    <name>origin_3</name>
                    <value>${origin_3}</value>
                </property>
                <property>
                    <name>input_3</name>
                    <value>${input_3}</value>
                </property>
                <property>
                    <name>schema_input</name>
                    <value>${schema_input}</value>
                </property>
                <!-- Output port bound to given path -->
                <property>
                    <name>output</name>
                    <value>${workingDir}/removebelowthreshold/output</value>
                </property>
                <property>
                    <name>schema_output</name>
                    <value>${schema_input_envelope}</value>
                </property>
            </configuration>
        </sub-workflow>
        <ok to="removebelowthreshold"/>
        <error to="fail"/>
    </action>
    
    <action name="removebelowthreshold">
        <sub-workflow>
            <app-path>${wf:appPath()}/removebelowthreshold</app-path>
            <configuration>
                <property>
                    <name>jobTracker</name>
                    <value>${jobTracker}</value>
                </property>
                <property>
                    <name>nameNode</name>
                    <value>${nameNode}</value>
                </property>
                <property>
                    <name>queueName</name>
                    <value>${queueName}</value>
                </property>
                <!-- Working directory of the subworkflow -->
                <property>
                    <name>workingDir</name>
                    <value>${workingDir}/removebelowthreshold/working_dir</value>
                </property>
                <!-- Input ports & parameters. -->
                <property>
                    <name>id_field_to_replace1</name>
                    <value>${id_field_to_replace1}</value>
                </property>
                <property>
                    <name>id_field_to_replace2</name>
                    <value>${id_field_to_replace2}</value>
                </property>
                <property>
                    <name>input</name>
                    <value>${workingDir}/removebelowthreshold/output</value>
                </property>
                <property>
                    <name>schema_input</name>
                    <value>${schema_input_envelope}</value>
                </property>
                <property>
                    <name>input_id_mapping</name>
                    <value>${input_id_mapping}</value>
                </property>
                <!-- Output port bound to given path -->
                <property>
                    <name>output</name>
                    <value>${workingDir}/removebelowthreshold/output</value>
                </property>
            </configuration>
        </sub-workflow>
        <ok to="collapser"/>
        <error to="fail"/>
    </action>

        <action name="collapser">
        <sub-workflow>
            <app-path>${wf:appPath()}/collapser</app-path>
            <configuration>
                <property>
                    <name>jobTracker</name>
                    <value>${jobTracker}</value>
                </property>
                <property>
                    <name>nameNode</name>
                    <value>${nameNode}</value>
                </property>
                <property>
                    <name>queueName</name>
                    <value>${queueName}</value>
                </property>
                <!-- Working directory of the subworkflow -->
                <property>
                    <name>workingDir</name>
                    <value>${workingDir}/collapser/working_dir</value>
                </property>
                <property>
                    <name>key_id_field</name>
                    <value>${key_id_field}</value>
                </property>
                <property>
                    <name>origins</name>
                    <value>${origin_1},${origin_2},${origin_3}</value>
                </property>
                <property>
                    <name>between_origin_collapser</name>
                    <value>${between_origin_collapser}</value>
                </property>
                <property>
                    <name>within_origin_collapser</name>
                    <value>${within_origin_collapser}</value>
                </property>
                <property>
                    <name>significant_fields</name>
                    <value>${significant_fields}</value>
                </property>
                <property>
                    <name>schema_input</name>
                    <value>${schema_input_envelope}</value>
                </property>
                <property>
                    <name>schema_output</name>
                    <value>${schema_input}</value>
                </property>
                <!-- Input ports. -->
                <property>
                    <name>input</name>
                    <value>${workingDir}/removebelowthreshold/output</value>
                </property>
                <!-- Output port bound to given path -->
                <property>
                    <name>output</name>
                    <value>${output}</value>
                </property>
            </configuration>
        </sub-workflow>
        <ok to="end"/>
        <error to="fail"/>
    </action>
    
	<kill name="fail">
		<message>Unfortunately, the process failed -- error message:
			[${wf:errorMessage(wf:lastErrorNode())}]
		</message>
	</kill>
	<end name="end" />
</workflow-app>
